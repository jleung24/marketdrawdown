{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Market Drawdown</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <!-- htmx CDN -->
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
  <!-- noUiSlider CSS and JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

</head>
<body>
  <div class="main-container">
    <form 
      hx-post="/get_data/"
      hx-target="#dashboard"
      hx-swap="innerHTML"
      id="rangeForm"
      method="POST"
    >
      {% csrf_token %}
      <div class="slider-container">
      <div class="slider-row">
        <div>
          <label for="slider-round">Drawdown (%)</label>
          <div class="slider-styled" id="slider-round"></div>
        </div>
        <div>
          <label for="slider-round-2" title="Days since peak, from drawdown">Drawdown Period (Days)</label>
          <div class="slider-styled" id="slider-round-2"></div>
        </div>
        <div>
          <label for="slider-round-3">Recovery Target (%)</label>
          <div class="slider-styled" id="slider-round-3"></div>
        </div>
        <div>
          <button type="submit" id="submitBtn">Calculate</button>
        </div>
      </div>
      </div>
      <input type="hidden" name="drawdown_range_min" id="drawdown_range_min">
      <input type="hidden" name="drawdown_range_max" id="drawdown_range_max">

      <input type="hidden" name="duration_range_min" id="duration_range_min">
      <input type="hidden" name="duration_range_max" id="duration_range_max">

      <input type="hidden" name="recovery_target" id="recovery_target">
    </form>

    <div class="dashboard-container">
      <div id="dashboard"></div>
    </div>
  </div>

  <div id="spinner-overlay" style="display:none;">
  <div class="spinner-backdrop"></div>
  <div class="spinner-center">
      <svg width="60" height="60" viewBox="0 0 40 40">
        <circle cx="20" cy="20" r="16" stroke="#6aa56f" stroke-width="4" fill="none" stroke-linecap="round">
          <animate attributeName="stroke-dasharray" values="1,150;90,150;90,150" dur="1.5s" repeatCount="indefinite"/>
          <animate attributeName="stroke-dashoffset" values="0;-35;-124" dur="1.5s" repeatCount="indefinite"/>
          <animate attributeName="stroke" values="#6aa56f;#616fac;#cf6d75" dur="3s" repeatCount="indefinite"/>
        </circle>
      </svg>
      <div style="color:#fff; margin-top:1em;">Loading...</div>
    </div>
  </div>

  
  <script>
    // Initialize noUiSlider
    var slider = document.getElementById('slider-round');
    noUiSlider.create(slider, {
      start: [10, 30],
      connect: true,
      range: {
        'min': 5,
        '85': 50,
        'max': 100
      },
      step: 1,
      tooltips: [true, true],
      format: {
        to: function (value) { return Math.round(value); },
        from: function (value) { return Number(value); }
      }
    });
    

    // Update hidden inputs and displayed values
    var drawdown_min = document.getElementById('drawdown_range_min');
    var drawdown_max = document.getElementById('drawdown_range_max');

    slider.noUiSlider.on('update', function(values, handle) {
      var min = Math.min(values[0], values[1]);
      var max = Math.max(values[0], values[1]);
      drawdown_min.value = min;
      drawdown_max.value = max;
    });

    // Initialize values on page load
    slider.noUiSlider.set([10, 30]);


    var slider_2 = document.getElementById('slider-round-2');
    noUiSlider.create(slider_2, {
      start: [0, 300],
      connect: true,
      range: {
        'min': [0],
        '50%': [360],
        'max': [3600]
      },
      step: 1,
      tooltips: [true, true],
      format: {
        to: function (value) { return Math.round(value); },
        from: function (value) { return Number(value); }
      }
    });

    // Update hidden inputs and displayed values
    var duration_min = document.getElementById('duration_range_min');
    var duration_max = document.getElementById('duration_range_max');

    slider_2.noUiSlider.on('update', function(values, handle) {
      var min = Math.min(values[0], values[1]);
      var max = Math.max(values[0], values[1]);
      duration_min.value = min;
      duration_max.value = max;
    });

    // Initialize values on page load
    slider_2.noUiSlider.set([0, 300]);

    var slider_3 = document.getElementById('slider-round-3');
    noUiSlider.create(slider_3, {
      start: 85,
      connect: 'lower',
      range: {
        'min': 5,
        'max': 100
      },
      step: 1,
      tooltips: true,
      format: {
        to: function (value) { return Math.round(value); },
        from: function (value) { return Number(value); }
      }
    });
    

    var recovery_target= document.getElementById('recovery_target');

    slider_3.noUiSlider.on('update', function(values, handle) {
      var target = values;
      recovery_target.value = target;
    });

    // Set the slider to a new value
    slider_3.noUiSlider.set(85);

  </script>


  <script>
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
      document.getElementById('spinner-overlay').style.display = 'flex';
    });
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      document.getElementById('spinner-overlay').style.display = 'none';
    });
    document.body.addEventListener('htmx:responseError', function(evt) {
      document.getElementById('spinner-overlay').style.display = 'none';
    });
  </script>


  <script>
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
      document.getElementById('submitBtn').disabled = true;
    });
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      document.getElementById('submitBtn').disabled = false;
    });
    document.body.addEventListener('htmx:responseError', function(evt) {
      document.getElementById('submitBtn').disabled = false;
    });
  </script>

</body>
</html>
